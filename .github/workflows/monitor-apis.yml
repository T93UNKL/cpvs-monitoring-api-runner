name: CPVS API Monitoring

on:
  schedule:
    # Run every hour at the top of the hour
    - cron: '0 * * * *'
  workflow_dispatch:  # Allow manual trigger

jobs:
  monitor-apis:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Run API Monitoring
      env:
        CPVS_DOMAIN: ${{ secrets.CPVS_DOMAIN }}
      run: |
        python monitor_apis.py --domain $CPVS_DOMAIN --output monitoring_report.json
    
    - name: Upload Monitoring Report
      uses: actions/upload-artifact@v4
      with:
        name: monitoring-report
        path: monitoring_report.json
        retention-days: 30
    
    - name: Send Email Report
      env:
        SMTP_SERVER: ${{ secrets.SMTP_SERVER }}
        SMTP_PORT: ${{ secrets.SMTP_PORT }}
        SENDER_EMAIL: ${{ secrets.SENDER_EMAIL }}
        SENDER_PASSWORD: ${{ secrets.SENDER_PASSWORD }}
        RECIPIENT_EMAILS: ${{ secrets.RECIPIENT_EMAILS }}
      run: |
        python email_report.py \
          --report monitoring_report.json \
          --recipients $RECIPIENT_EMAILS \
          --smtp-server $SMTP_SERVER \
          --smtp-port $SMTP_PORT \
          --sender-email $SENDER_EMAIL \
          --sender-password "$SENDER_PASSWORD" \
          --attach
    
    - name: Report Status
      if: failure()
      run: |
        echo "⚠️ Monitoring failed! Check the logs above for details."
        exit 1
